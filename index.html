<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>US COVID-19 Workplace Outbreaks â€“ 2021 Dashboard</title>

  <!-- Bootstrap for quick, responsive layout -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
  >
  <!-- DataTables for the full interactive table -->
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css"
  >
  <style>
    body { background:#f7f9fc }
    .card { border:none; box-shadow:0 2px 8px rgba(0,0,0,.05) }
    .metric { font-size:2.2rem;font-weight:600 }
  </style>
</head>
<body class="p-3">

<div class="container-fluid">
  <h1 class="mb-4 fw-bold text-center">COVID-19 Workplace Outbreaks (USA, 2021)</h1>

  <!-- KPI cards -->
  <div class="row g-3 mb-4" id="kpiRow"></div>

  <!-- Charts -->
  <div class="row g-3">
    <div class="col-lg-6">
      <div class="card p-3">
        <h5 class="card-title">Top 10 Industry Sectors by Outbreaks</h5>
        <div id="sectorChart"></div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card p-3">
        <h5 class="card-title">Top 10 Individual Settings by Outbreaks</h5>
        <div id="settingChart"></div>
      </div>
    </div>
  </div>

  <!-- Full dataset table -->
  <div class="card p-3 mt-4">
    <h5 class="card-title">Explore the Full Dataset (filter & search)</h5>
    <table id="dataTable" class="table table-striped" style="width:100%"></table>
  </div>
</div>

<!-- JS libraries -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.3/papaparse.min.js"></script>
<script src="https://cdn.plot.ly/plotly-2.29.1.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

<script>
/* ========= 1. Load the CSV (must live in the same repo) ========= */
Papa.parse('covid-19outbreakstotal2021byindustry_02apr25.csv', {
  download: true,
  header: true,
  complete: function(results) {
    const data = results.data;
    buildDashboard(data);
  }
});

/* ========= 2. Dashboard logic ========= */
function buildDashboard(data) {
  // Helper to coerce numbers
  data.forEach(d=>{
    d.Cases = +d.Cases;
    d.Outbreaks = +d.Outbreaks;
  });

  /* ----- KPI cards ----- */
  const totalOutbreaks = d3sum(data,'Outbreaks');
  const totalCases     = d3sum(data,'Cases');
  const distinctSectors = new Set(data.map(d=>d.IndustrySector)).size;
  const distinctSettings= new Set(data.map(d=>d.IndividualSetting)).size;
  const KPIs = [
    {label:'Total Outbreaks',value:totalOutbreaks.toLocaleString()},
    {label:'Total Confirmed Cases',value:totalCases.toLocaleString()},
    {label:'Industry Sectors',value:distinctSectors},
    {label:'Individual Settings',value:distinctSettings}
  ];
  document.getElementById('kpiRow').innerHTML = KPIs.map(k=>`
    <div class="col-6 col-lg-3">
      <div class="card text-center p-3">
        <div class="metric">${k.value}</div>
        <small class="text-muted">${k.label}</small>
      </div>
    </div>`).join('');

  /* ----- Aggregations ----- */
  const bySector  = rollupSum(data,'IndustrySector');
  const bySetting = rollupSum(data,'IndividualSetting')
                      .filter(d=>!['Total','All Settings'].includes(d.name));

  const topSector  = bySector  .slice(0,10);
  const topSetting = bySetting .slice(0,10);

  /* ----- Bar Charts ----- */
  makeBar('sectorChart', topSector, 'Industry Sector');
  makeBar('settingChart', topSetting, 'Individual Setting');

  /* ----- Full DataTable ----- */
  $('#dataTable').DataTable({
    data,
    columns: Object.keys(data[0]).map(k=>({title:k,data:k})),
    pageLength: 15,
    responsive: true
  });
}

/* ========= 3. Helpers ========= */
function rollupSum(data, field){
  const map = {};
  data.forEach(d=>{
    const key = d[field] || 'Unknown';
    map[key] = (map[key]||0) + d.Outbreaks;
  });
  return Object.entries(map).map(([name,val])=>({name,val}))
          .sort((a,b)=>b.val - a.val);
}
function makeBar(divId, arr, xLabel){
  Plotly.newPlot(divId, [{
    x: arr.map(d=>d.name),
    y: arr.map(d=>d.val),
    type:'bar',
    text: arr.map(d=>d.val.toLocaleString()),
    textposition:'auto'
  }], {
    margin:{t:30,b:120},
    xaxis:{title:xLabel, tickangle:-40},
    yaxis:{title:'Outbreaks'},
    height:480
  }, {responsive:true});
}
// small utility for sum
function d3sum(arr,field){ return arr.reduce((acc,x)=>acc+(+x[field]||0),0); }
</script>
</body>
</html>
