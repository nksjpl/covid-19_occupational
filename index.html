<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>COVID‑19 Outbreaks Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap 5.3.x (pinned) -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        integrity="sha384-9ndCyUa7SA/N1Qp+Fftyd7jckq9Q1DPZb7p4v8N21JxrYhXBqlp7sRy21yMibVc3"
        crossorigin="anonymous">

  <!-- DataTables 1.13.x CSS -->
  <link rel="stylesheet"
        href="https://cdn.datatables.net/1.13.10/css/jquery.dataTables.min.css">

  <style>
    /* ─── General ──────────────────────────────────────────────────────── */
    body{
      background:#f3f4f6; /* light slate */
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue","Noto Sans","Liberation Sans",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
    }

    h3{
      font-weight:700;
      letter-spacing:-.02em;
    }

    /* ─── KPI ROW ─────────────────────────────────────────────────────── */
    #kpiRow{
      display:flex;            /* horizontal layout */
      flex-wrap:nowrap;        /* single row */
      gap:1rem;                /* space between cards */
      overflow-x:auto;         /* scroll on small screens */
      padding-bottom:0.25rem;  /* give space under the row */
      scrollbar-width:thin;    /* Firefox */
    }
    #kpiRow::-webkit-scrollbar{height:.5rem}
    #kpiRow::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:.25rem}

    /* ─── KPI CARD ────────────────────────────────────────────────────── */
    .kpi-card{
      min-width:180px;        /* ensure readable width */
      border-radius:.75rem;   /* 12px */
      box-shadow:0 4px 10px rgba(0,0,0,.08);
      padding:1.25rem 1.5rem; /* generous inner spacing */
      color:#fff;
      position:relative;
      overflow:hidden;
      transition:transform .2s ease,box-shadow .2s ease;
    }
    .kpi-card:hover{
      transform:translateY(-4px);
      box-shadow:0 8px 20px rgba(0,0,0,.15);
    }
    .kpi-label{
      font-size:.75rem;    /* 12px */
      font-weight:600;     /* semibold */
      text-transform:uppercase;
      letter-spacing:.05em;
      opacity:.9;
      margin-bottom:.25rem;
      white-space:nowrap;
    }
    .kpi-value{
      font-size:2rem;      /* 32px */
      font-weight:700;
      line-height:1.1;
    }

    /* Vibrant palette */
    .bg-indigo {background:#4f46e5;}
    .bg-teal   {background:#14b8a6;}
    .bg-amber  {background:#f59e0b;}
    .bg-emerald{background:#10b981;}
    .bg-coral  {background:#ff7f50;}
    .bg-violet {background:#8b5cf6;}
    .bg-sky    {background:#38bdf8;}
    .bg-slate  {background:#64748b;}

    /* ─── Containers ──────────────────────────────────────────────────── */
    .chart-wrapper,.table-responsive{
      background:#fff;
      border-radius:.75rem;
      border:1px solid #e2e8f0;
      box-shadow:0 2px 6px rgba(0,0,0,.05);
      padding:1rem;
    }
    .chart-wrapper h6{color:#475569;font-weight:600;}

  </style>
</head>
<body>
<div class="container-fluid py-4">

  <h3 class="mb-4 text-center text-secondary">COVID‑19 Outbreaks Dashboard</h3>

  <!-- ── KPI CARDS ────────────────────────────────────────────── -->
  <div id="kpiRow"><!-- KPI cards injected by JS --></div>

  <!-- ── CHARTS ──────────────────────────────────────────────── -->
  <div class="row gy-4 mb-4">
    <div class="col-12 col-lg-6">
      <div class="chart-wrapper h-100">
        <h6 class="text-center mb-3">Industry Sectors by Outbreaks (Excl. Total)</h6>
        <div id="sectorChart" role="img" aria-label="Bar chart showing the industry sectors with the most COVID‑19 outbreaks"></div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="chart-wrapper h-100">
        <h6 class="text-center mb-3">Industry Sectors by Total Cases (Excl. Total)</h6>
        <div id="sectorCasesChart" role="img" aria-label="Bar chart showing industry sectors with the most COVID‑19 cases"></div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="chart-wrapper h-100">
        <h6 class="text-center mb-3">Top 10 Individual Settings by Outbreaks</h6>
        <div id="settingChart" role="img" aria-label="Bar chart showing the settings with the most outbreaks"></div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="chart-wrapper h-100">
        <h6 class="text-center mb-3">Top 10 Individual Settings by Total Cases</h6>
        <div id="settingCasesChart" role="img" aria-label="Bar chart showing settings with the most cases"></div>
      </div>
    </div>
  </div>

  <!-- ── DATA TABLE ──────────────────────────────────────────── -->
  <div class="row gy-4">
    <div class="col-12">
      <div class="table-responsive">
        <table id="dataTable" class="display nowrap" style="width:100%">
          <thead class="table-light">
            <tr>
              <th>Year</th>
              <th>Industry Sector</th>
              <th>Individual Setting</th>
              <th>Ind Code</th>
              <th>Outbreaks</th>
              <th>Cases</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- ── SCRIPTS ──────────────────────────────────────────────── -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"
        integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.10/js/jquery.dataTables.min.js"></script>

<script>
/* -------------------------------------------------------------
   Configuration
----------------------------------------------------------------*/
const CSV_PATH = 'covid-19occu.csv';
const BAR_COLOR_PRIMARY = '#0d6efd';
const BAR_COLOR_ALT     = '#6f42c1';
const PLOTLY_CFG = {responsive:true,displayModeBar:false};
const PLOTLY_LAYOUT_BASE = {
  margin:{l:60,r:20,t:10,b:120},
  yaxis:{title:'Number of Outbreaks',tickformat:',',gridcolor:'rgba(0,0,0,.1)',fixedrange:true},
  xaxis:{tickangle:-45,automargin:true,fixedrange:true},
  hoverlabel:{bgcolor:'#FFF',font:{size:12}},
  paper_bgcolor:'rgba(0,0,0,0)',
  plot_bgcolor:'rgba(0,0,0,0)'
};

/* -------------------------------------------------------------
   Initialization
----------------------------------------------------------------*/
document.addEventListener('DOMContentLoaded',() => {
  Papa.parse(CSV_PATH,{
    download:true,header:true,dynamicTyping:true,skipEmptyLines:true,
    complete:({data,errors,meta}) => {
      if(errors.length){return onError(new Error('CSV parse errors'));}
      if(!data.length){return onError(new Error('CSV empty'));}
      buildDashboard(data);
    },
    error:onError
  });
});
function onError(err){console.error(err);alert('Failed to load data: '+err.message);}

/* -------------------------------------------------------------
   Dashboard Builder
----------------------------------------------------------------*/
function buildDashboard(rows){
  renderKpiCards(rows);
  plotSectorOutbreaks(rows);
  plotSectorCases(rows);
  plotSettingOutbreaks(rows);
  plotSettingCases(rows);
  populateTable(rows);
}

/* ── Helpers ──────────────────────────────────────────────── */
const aggregateTop = (arr,groupKey,sumKey,n,filter=() => true) => Object.entries(
  arr.filter(filter).reduce((a,r)=>{const k=r[groupKey];const v=+r[sumKey]||0;if(k)a[k]=(a[k]||0)+v;return a;},{}))
  .sort(([,a],[,b])=>b-a).slice(0,n);

/* ── KPI CARDS ─────────────────────────────────────────────── */
function renderKpiCards(rows){
  const wrap=document.getElementById('kpiRow');wrap.innerHTML='';
  const outbreaksByYear=rows.reduce((a,r)=>{const y=r.Year;const v=+r.Outbreaks||0;if(y)a[y]=(a[y]||0)+v;return a;},{});
  const years=Object.keys(outbreaksByYear).sort();
  const totalCases=rows.reduce((t,r)=>t+(+r.Cases||0),0);
  const sectors=new Set(rows.map(r=>r.IndustrySector).filter(Boolean)).size;
  const settings=new Set(rows.map(r=>r.IndividualSetting).filter(Boolean)).size;
  const kpis=[...years.map(y=>({label:`OUTBREAKS ${y}`,value:outbreaksByYear[y]})),
              {label:'TOTAL CASES',value:totalCases},
              {label:'INDUSTRY SECTORS',value:sectors},
              {label:'INDIVIDUAL SETTINGS',value:settings}];
  const palette=['bg-indigo','bg-teal','bg-amber','bg-emerald','bg-coral','bg-violet','bg-sky','bg-slate'];
  kpis.forEach((k,i)=>{
    wrap.insertAdjacentHTML('beforeend',`
      <div class="kpi-card ${palette[i%palette.length]}">
        <div class="kpi-label">${k.label}</div>
        <div class="kpi-value">${(+k.value||0).toLocaleString()}</div>
      </div>`);
  });
}

/* ── Charts ──────────────────────────────────────────────── */
function plotSectorOutbreaks(rows){
  const data=aggregateTop(rows,'IndustrySector','Outbreaks',Infinity,r=>!['total',''].includes(String(r.IndustrySector).toLowerCase().trim()));
  Plotly.newPlot('sectorChart',[{type:'bar',x:data.map(d=>d[0]),y:data.map(d=>d[1]),marker:{color:BAR_COLOR_PRIMARY},hovertemplate:'%{x}: %{y:,} outbreaks<extra></extra>'}],PLOTLY_LAYOUT_BASE,PLOTLY_CFG);
}
function plotSectorCases(rows){
  const data=aggregateTop(rows,'IndustrySector','Cases',Infinity,r=>!['total',''].includes(String(r.IndustrySector).toLowerCase().trim()));
  const layout={...PLOTLY_LAYOUT_BASE,yaxis:{...PLOTLY_LAYOUT_BASE.yaxis,title:'Total Cases'}};
  Plotly.newPlot('sectorCasesChart',[{type:'bar',x:data.map(d=>d[0]),y:data.map(d=>d[1]),marker:{color:BAR_COLOR_ALT},hovertemplate:'%{x}: %{y:,} cases<extra></extra>'}],layout,PLOTLY_CFG);
}
function plotSettingOutbreaks(rows){
  const data=aggregateTop(rows,'IndividualSetting','Outbreaks',10,r=>!['total','all settings','all setting','all',''].includes(String(r.IndividualSetting).toLowerCase().trim()));
  Plotly.newPlot('settingChart',[{type:'bar',x:data.map(d=>d[0]),y:data.map(d=>d[1]),marker:{color:BAR_COLOR_PRIMARY},hovertemplate:'%{x}: %{y:,} outbreaks<extra></extra>'}],PLOTLY_LAYOUT_BASE,PLOTLY_CFG);
}
function plotSettingCases(rows){
  const data=aggregateTop(rows,'IndividualSetting','Cases',10,r=>!['total','all settings','all setting','all',''].includes(String(r.IndividualSetting).toLowerCase().trim()));
  const layout={...PLOTLY_LAYOUT_BASE,yaxis:{...PLOTLY_LAYOUT_BASE.yaxis,title:'Total Cases'}};
  Plotly.newPlot('settingCasesChart',[{type:'bar',x:data.map(d=>d[0]),y:data.map(d=>d[1]),marker:{color:BAR_COLOR_ALT},hovertemplate:'%{x}: %{y:,} cases<extra></extra>'}],layout,PLOTLY_CFG);
}

/* ── DataTable ────────────────────────────────────────────── */
function populateTable(rows){
  if($.fn.DataTable.isDataTable('#dataTable')){$('#dataTable').DataTable().destroy();$('#dataTable tbody').empty();}
  const tb=document.querySelector('#dataTable tbody');
  rows.forEach(r=>{tb.insertAdjacentHTML('beforeend',`<tr><td>${r.Year??''}</td><td>${r.IndustrySector??''}</td><td>${r.IndividualSetting??''}</td><td>${r.IndCode??''}</td><td>${(+r.Outbreaks||0).toLocaleString()}</td><td>${(+r.Cases||0).toLocaleString()}</td></tr>`);});
  $('#dataTable').DataTable({pageLength:10,lengthMenu:[10,25,50,100],order:[[4,'desc']],responsive:true,dom:'<"row"<"col-md-6"l><"col-md-6"f>><"row"<"col-12"tr>><"row"<"col-md-5"i><"col-md-7"p>>',language:{search:"_INPUT_",searchPlaceholder:"Search table..."}});
}
</script>
</body>
</html>
